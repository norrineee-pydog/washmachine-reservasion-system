<!--pages/booking/booking.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="nav-header">
    <text class="nav-title">é¢„çº¦ç®¡ç†</text>
  </view>

  <!-- å½“å‰é¢„çº¦ -->
  <view class="current-booking-section" wx:if="{{currentBooking}}">
    <view class="section-header">
      <text class="section-title">å½“å‰é¢„çº¦</text>
    </view>
    <view class="current-booking-card">
      <view class="booking-header">
        <view class="booking-info">
          <text class="booking-machine">{{currentBooking.washerName}}</text>
          <text class="booking-location">{{currentBooking.buildingName}}</text>
        </view>
        <view class="booking-status {{currentBooking.status || 'pending'}}">
          <text>{{currentBooking.statusText}}</text>
        </view>
      </view>
      <view class="booking-time">
        <text class="time-label">é¢„çº¦æ—¶é—´</text>
        <text class="time-value">{{currentBooking.bookingTime}}</text>
      </view>
      <view class="booking-countdown">
        <text class="countdown-text">{{currentBooking.remainingTime}}</text>
      </view>
      <view class="booking-actions">
        <button class="btn btn-secondary" bindtap="cancelBooking" wx:if="{{currentBooking.status === 'pending'}}">å–æ¶ˆé¢„çº¦</button>
        <button class="btn btn-primary" bindtap="viewBookingDetail">æŸ¥çœ‹è¯¦æƒ…</button>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿé¢„çº¦ -->
  <view class="quick-booking-section">
    <view class="section-header">
      <text class="section-title">å¿«é€Ÿé¢„çº¦</text>
    </view>
    <view class="quick-booking-cards">
      <view class="quick-card" bindtap="quickBook" data-type="immediate">
        <view class="card-icon immediate">âš¡</view>
        <text class="card-title">ç«‹å³é¢„çº¦</text>
        <text class="card-desc">é€‰æ‹©ç©ºé—²æ´—è¡£æœºç«‹å³ä½¿ç”¨</text>
        <text class="card-tip" wx:if="{{availableWasherCount > 0}}">{{availableWasherCount}}å°å¯ç”¨</text>
        <text class="card-tip" wx:else>æš‚æ— å¯ç”¨</text>
      </view>
      <view class="quick-card" bindtap="quickBook" data-type="schedule">
        <view class="card-icon schedule">ğŸ•</view>
        <text class="card-title">æ—¶æ®µé¢„çº¦</text>
        <text class="card-desc">é¢„çº¦æœªæ¥æ—¶æ®µæ´—è¡£æœ</text>
        <text class="card-tip">æå‰è§„åˆ’</text>
      </view>
    </view>
  </view>

  <!-- æ™ºèƒ½æ¨è -->
  <view class="recommendation-section" wx:if="{{recommendations.length > 0}}">
    <view class="section-header">
      <text class="section-title">æ™ºèƒ½æ¨è</text>
    </view>
    <view class="recommendation-list">
      <block wx:for="{{recommendations}}" wx:key="id">
        <view class="recommendation-item" bindtap="selectRecommendation" data-recommendation="{{item}}">
          <view class="recommendation-time">
            <text class="time-slot">{{item.time}}</text>
            <text class="time-date">{{item.date}}</text>
          </view>
          <view class="recommendation-content">
            <text class="recommendation-desc">{{item.description}}</text>
            <view class="recommendation-score">
              <text class="score-value">{{item.score}}%</text>
              <text class="score-text">æ¨èåº¦</text>
            </view>
          </view>
          <view class="recommendation-arrow">â€º</view>
        </view>
      </block>
    </view>
  </view>

  <!-- é¢„çº¦ç»Ÿè®¡ -->
  <view class="statistics-section">
    <view class="section-header">
      <text class="section-title">æˆ‘çš„ç»Ÿè®¡</text>
    </view>
    <view class="statistics-cards">
      <view class="stat-card">
        <text class="stat-number">{{statistics.totalBookings}}</text>
        <text class="stat-label">æ€»é¢„çº¦</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{statistics.successRate}}%</text>
        <text class="stat-label">æˆåŠŸç‡</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{statistics.avgWaitTime}}</text>
        <text class="stat-label">å¹³å‡ç­‰å¾…</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{statistics.creditScore}}</text>
        <text class="stat-label">ä¿¡ç”¨åˆ†</text>
      </view>
    </view>
  </view>

  <!-- é¢„çº¦è®°å½• -->
  <view class="history-section">
    <view class="section-header">
      <text class="section-title">é¢„çº¦è®°å½•</text>
      <view class="section-actions">
        <text class="action-text" bindtap="showSearch" wx:if="{{bookingHistory.length > 0}}">æœç´¢</text>
      </view>
    </view>

    <!-- æœç´¢æ¡† -->
    <view class="search-container" wx:if="{{showSearch}}">
      <view class="search-box">
        <input class="search-input" 
               placeholder="æœç´¢æ´—è¡£æœºã€ä½ç½®ã€çŠ¶æ€..." 
               value="{{searchKeyword}}"
               bindinput="onSearchInput"/>
        <text class="search-cancel" bindtap="hideSearch">å–æ¶ˆ</text>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loadingHistory}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:elif="{{bookingHistory.length === 0}}">
      <text class="empty-text">æš‚æ— é¢„çº¦è®°å½•</text>
      <text class="empty-desc">å¿«å»é¢„çº¦ç¬¬ä¸€å°æ´—è¡£æœºå§</text>
    </view>

    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <view class="history-list" wx:else>
      <block wx:for="{{showSearch ? filteredHistory : bookingHistory}}" wx:key="id">
        <view class="history-item" bindtap="viewHistoryDetail" data-booking="{{item}}">
          <view class="history-info">
            <view class="history-header">
              <text class="history-machine">{{item.washerName}}</text>
              <view class="history-status {{item.status}}">
                <text>{{item.statusText}}</text>
              </view>
            </view>
            <view class="history-details">
              <text class="history-location">{{item.machineLocation || item.buildingName}}</text>
              <text class="history-time">{{item.bookingTime}}</text>
            </view>
            <view class="history-footer">
              <text class="history-price" wx:if="{{item.totalPrice}}">ï¿¥{{item.totalPrice}}</text>
              <text class="history-date">{{item.reservationDate}}</text>
            </view>
          </view>
          <view class="history-actions">
            <button class="history-cancel-btn" wx:if="{{item.canCancel}}" catchtap="cancelHistoryBooking" data-booking="{{item}}">å–æ¶ˆ</button>
            <view class="history-arrow">â€º</view>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- æ—¶é—´é€‰æ‹©å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showTimePicker}}" bindtap="closeTimePicker">
    <view class="modal-content" bindtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©é¢„çº¦æ—¶é—´</text>
        <text class="modal-close" bindtap="closeTimePicker">Ã—</text>
      </view>

      <view class="duration-selector">
        <text class="duration-title">é€‰æ‹©æ´—è¡£æ—¶é•¿</text>
        <view class="duration-options">
          <block wx:for="{{durationOptions}}" wx:key="value">
            <view 
              class="duration-option {{selectedDuration === item.value ? 'active' : ''}}"
              bindtap="selectDuration"
              data-duration="{{item.value}}"
            >
              <text>{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>
      
      <!-- æ—¥æœŸé€‰æ‹© -->
      <view class="date-selector">
        <scroll-view class="date-list" scroll-x>
          <block wx:for="{{availableDates}}" wx:key="date">
            <view class="date-item {{selectedDate.date === item.date ? 'active' : ''}}" 
                  bindtap="selectDate" data-date="{{item}}">
              <text class="date-day">{{item.dayText}}</text>
              <text class="date-date">{{item.dateText}}</text>
            </view>
          </block>
        </scroll-view>
      </view>

      <!-- æ—¶é—´æ®µé€‰æ‹© -->
      <view class="time-slots-section">
        <view class="time-header">
          <text class="time-title">å¯é€‰æ—¶é—´æ®µ</text>
          <text class="time-date">{{selectedDate.dayText}} {{selectedDate.dateText}}</text>
        </view>
        <scroll-view class="time-slots-list" scroll-y>
          <block wx:for="{{timeSlots}}" wx:key="id">
            <view class="time-slot-item {{selectedTimeSlot && selectedTimeSlot.id === item.id ? 'selected' : ''}} {{item.available ? '' : 'disabled'}}" 
                  bindtap="selectTimeSlot" data-slot="{{item}}" wx:if="{{item.available}}">
              <view class="slot-time">
                <text class="time-range">{{item.time}}</text>
                <text class="slot-tip" wx:if="{{item.availableCount > 0}}">{{item.availableCount}}å°å¯ç”¨</text>
              </view>
              <view class="slot-status">
                <text class="status-text {{item.isPeakTime ? 'peak' : 'normal'}}">
                  {{item.isPeakTime ? 'é«˜å³°' : 'ç©ºé—²'}}
                </text>
              </view>
            </view>
          </block>
          
          <!-- æ— å¯ç”¨æ—¶æ®µæç¤º -->
          <view class="no-slots-tip" wx:if="{{timeSlots.length > 0 && availableSlotsCount === 0}}">
            <text class="tip-text">è¯¥æ—¥æœŸæš‚æ— å¯ç”¨æ—¶æ®µ</text>
            <text class="tip-desc">è¯·é€‰æ‹©å…¶ä»–æ—¥æœŸ</text>
          </view>
        </scroll-view>
      </view>

      <!-- ç¡®è®¤æŒ‰é’® -->
      <view class="modal-actions">
        <button class="btn btn-cancel" bindtap="closeTimePicker">å–æ¶ˆ</button>
        <button class="btn btn-confirm" bindtap="confirmTimeBooking" disabled="{{!selectedTimeSlot}}">ç¡®è®¤é¢„çº¦</button>
      </view>
    </view>
  </view>

  <!-- æ´—è¡£æœºé€‰æ‹©å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showWasherPicker}}" bindtap="closeWasherPicker">
    <view class="modal-content washer-modal" bindtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©æ´—è¡£æœº</text>
        <text class="modal-close" bindtap="closeWasherPicker">Ã—</text>
      </view>

      <view class="duration-selector washer-duration">
        <text class="duration-title">æ´—è¡£æ—¶é•¿</text>
        <view class="duration-options">
          <block wx:for="{{durationOptions}}" wx:key="value">
            <view 
              class="duration-option {{selectedDuration === item.value ? 'active' : ''}}"
              bindtap="selectDuration"
              data-duration="{{item.value}}"
            >
              <text>{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- æ´—è¡£æœºåˆ—è¡¨ -->
      <view class="washer-selector">
        <view class="washer-count">
          <text class="count-text">å…± {{availableWashers.length}} å°å¯ç”¨æ´—è¡£æœº</text>
        </view>
        <scroll-view class="washer-list-modal" scroll-y>
          <block wx:for="{{availableWashers}}" wx:key="id">
            <view class="washer-item-modal {{selectedWasher && selectedWasher.id === item.id ? 'selected' : ''}}" 
                  bindtap="selectWasher" data-washer="{{item}}">
              <view class="washer-info-modal">
                <view class="washer-header-modal">
                  <text class="washer-name-modal">{{item.name}}</text>
                  <view class="washer-status-modal idle">
                    <text>{{item.statusText}}</text>
                  </view>
                </view>
                <view class="washer-details-modal">
                  <text class="washer-location-modal">{{item.location}}</text>
                  <text class="washer-type-modal">{{item.type}} Â· {{item.capacity}}</text>
                </view>
                <view class="washer-footer-modal">
                  <text class="washer-price-modal">ï¿¥{{item.pricePerHour}}/å°æ—¶</text>
                  <text class="washer-desc-modal">{{item.description}}</text>
                </view>
              </view>
              <view class="washer-checkbox">
                <text class="checkbox-icon" wx:if="{{selectedWasher && selectedWasher.id === item.id}}">âœ“</text>
              </view>
            </view>
          </block>

          <!-- æ— å¯ç”¨æ´—è¡£æœºæç¤º -->
          <view class="no-washers-tip" wx:if="{{availableWashers.length === 0}}">
            <text class="tip-text">æš‚æ— å¯ç”¨æ´—è¡£æœº</text>
            <text class="tip-desc">è¯·ç¨åå†è¯•æˆ–é€‰æ‹©æ—¶æ®µé¢„çº¦</text>
          </view>
        </scroll-view>
      </view>

      <!-- ç¡®è®¤æŒ‰é’® -->
      <view class="modal-actions">
        <button class="btn btn-cancel" bindtap="closeWasherPicker">å–æ¶ˆ</button>
        <button class="btn btn-confirm" bindtap="confirmWasherBooking" disabled="{{!selectedWasher}}">ç¡®è®¤é¢„çº¦</button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area"></view>
</view>