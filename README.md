# 上大洗衣侠 - 洗衣机预约小程序

## 项目简介（一编）

上大洗衣侠是一款专为上海大学学生设计的洗衣机预约管理小程序，旨在解决宿舍楼共用洗衣机资源紧张、排队难、状态不透明等问题。通过技术手段优化公共资源使用效率，提升学生生活质量。

## 功能特性

### 核心功能
- ✅ **微信授权登录** - 一键登录，免去注册流程
- ✅ **智能楼栋识别** - 基于位置信息自动识别所在楼栋
- ✅ **实时状态展示** - 可视化显示洗衣机使用状态
- ✅ **智能预约系统** - 支持立即预约和时段预约
- ✅ **消息提醒系统** - 预约成功、设备就绪等消息推送
- ✅ **信用积分体系** - 基于使用行为的信用管理

# 洗衣机预约小程序（二编）

## 一、用户使用指南
1. **首次登录**  
   - 打开小程序自己到我的进入至登录页，授权微信后填写学号、楼栋、房间和手机号，即可创建专属账号并同步到云端。
2. **发起预约**  
   - 在“预约管理”页面选择“立即预约”或“时段预约”，先挑洗衣时长（25 / 45 / 60 分），再选日期时段与洗衣机。确认后即可生成订单，并开启 15 分钟付款倒计时。
3. **付款与使用**  
   - 详情页支持“模拟付款”，付款后可按“开始洗衣”。洗程结束记得点击“完成洗衣”，可获得信用加分。（我们基于实际考虑并未接入真实付款）
4. **取消预约**  
   - 在“当前预约”、历史列表或“我的预约”中点击取消即可释放时段，系统会同步扣除信用分。（我们这个洗衣机程序再取消预约的时候出现报错是正常的，因为由于时间关系我们没有接入正常的付款，请忽略掉这个bug：）
5. **查看记录和统计**  
   - “我的预约”可按状态筛选并搜索，统计卡片显示总次数、成功率、平均等待和当前信用分；最近活动区可快速了解最近的状态变化。
6. **帮助与客服**  
   - 帮助中心提供使用指南、预约流程、信用积分说明以及常见故障排查，若仍有问题，可透过客服联系方式反馈。

---

## 二、小程序开发过程中的核心功能模块与知识点

| 模块 | 主要文件/入口 | 功能概述 | 关键知识点 |
| ---- | ------------- | -------- | ---------- |
| 预约管理 | `pages/booking/` | 可立即预约、时段预约、动态选择洗衣机、实时监听时段变化 | 小程序数据绑定与弹窗交互、`wx.cloud.database().watch` 实时监听、动态列表与状态管理 |
| 预约详情 | `pages/booking-detail/` | 展示预约信息，支持模拟付款、开始、完成、取消 | 云函数调用、倒计时实现、状态机设计、异常提示 |
| 我的预约 | `pages/my-booking/` | 历史记录筛选、快速操作、徽章计数 | 列表过滤、事件冒泡控制、批量调用云函数更新状态 |
| 个人中心 | `pages/profile/` | 用户资料、信用积分、统计与活动日志 | 全局 `app.globalData` 同步、云函数聚合统计、图表/徽章展示 |
| 帮助中心 | `pages/help/` | 使用指南、流程、信用规则及故障排查 | 静态内容组织、交互式弹窗、FAQ 折叠列表 |
| 云函数 | `cloudfunctions/` | `createReservation`、`cancelReservation`、`updateReservationStatus`、`getMyReservations`、`userProfile` | `wx-server-sdk` 数据库操作、权限验证、状态历史记录、信用分计算、`_.or`/`_.and` 组合查询 |

---

## 三、2025/11/8最后一次代码改动汇总

### 前端
- `pages/booking/`：新增多时长选项、实时监听、历史记录取消按钮及统一时间显示；修复倒计时与统计同步问题。
- `pages/booking-detail/`：扩充操作按钮（模拟付款/开始/完成），补齐洗衣时长、时段与价格展示。
- `pages/my-booking/`：事件改用 `catchtap`，补充状态按钮，避免 `stopPropagation` 报错。
- `pages/profile/profile.js`：统计数据改用云函数 `getMyReservations` 并重新计算总时长。
- `pages/help/help.js`：补完“使用指南 / 预约流程 / 信用积分 / 故障排查”文案以及弹窗提示。

### 后端（云函数）
- `createReservation`：计算任意时长的结束时间、最低计价、补齐 `reservationTimeRange` 与 `statusHistory`。
- `cancelReservation`：同时校验 `userId` 与 `_openid`，正确初始化/更新信用分；`set({ data })` 写法修正。
- `updateReservationStatus`：权限验证、信用加分，模拟付款/开始/完成全流程。
- `getMyReservations`：查询条件兼容 `userId` 与 `_openid`，与前端统计和列表同步。
- `userProfile`：使用 `update` 合并资料，避免 `_id` 被覆盖，保持信用历史。

---

## 四、如何在本地运行

1. **克隆项目**
   ```bash
   git clone <repo-url>
   ```
2. **微信开发者工具导入**
   - 打开工具 → “导入项目” → 选择本仓库路径 → 填写你的 AppID（wx5726e4c3725e558c）。
3. **初始化云开发**
   - 开启云环境（确保已有 `user`、`machines`、`reservations` 集合）。
   - 如需示例数据，可将 `database_backup` 中的 JSON 导入对应集合。
4. **部署云函数**
   - 在左侧 `cloudfunctions` 目录下，分别右键 `createReservation`、`cancelReservation` 等（不需要部署quickstartFunctions） → “上传并部署：云端安装依赖”。
   - 若存在未使用的模板函数（如 `quickstartFunctions`），请避免勾选。
5. **运行与调试**
   - 点击“预览”或“真机调试”，即可体验完整流程。
   - 若重新拉取资料，可在云数据库中清空旧集合后再执行。

完成以上步骤后，就能在本地完整运行和调试洗衣机预约小程序。祝使用顺利！
```
---

## 五、写在最后

### 致歉
- 由于时间关系，我们没有接入真实的付款、定位、现在天气。暂时未实现洗衣机最适时间预约的算法设计，所以我们上述提到的情况均采用随机算法进行生成。但保留了接口，若以后还有情况学有余力继续开发或者有后来人进行我们这个项目的升级，我们期待这个项目会进一步完善。




### 页面结构（三编）
- **首页** - 欢迎界面、快速操作、状态概览
- **楼栋选择** - 楼栋列表、地图模式、收藏功能
- **预约管理** - 预约创建、历史记录、使用统计
- **个人中心** - 用户信息、信用积分、设置选项
- **消息中心** - 系统通知、预约提醒
- **信用中心** - 积分规则、等级特权
- **帮助中心** - 使用指南、常见问题

## 技术架构

### 前端技术栈
- **微信小程序原生框架** - 使用微信小程序原生开发
- **WeUI组件库** - 提供统一的UI组件
- **腾讯地图SDK** - 集成地图功能（预留）
- **微信云开发** - 后端服务

### 项目结构
```
├── app.js                 # 小程序入口文件
├── app.json              # 全局配置
├── app.wxss              # 全局样式
├── sitemap.json          # 站点地图
├── project.config.json   # 项目配置
├── pages/                # 页面目录
│   ├── index/            # 首页
│   ├── login/            # 登录页
│   ├── building/         # 楼栋选择
│   ├── booking/          # 预约管理
│   ├── booking-detail/   # 预约详情
│   ├── profile/          # 个人中心
│   ├── message/          # 消息中心
│   ├── credit/           # 信用中心
│   └── help/             # 帮助中心
├── utils/                # 工具函数
│   ├── util.js           # 通用工具
│   └── api.js            # API封装
└── images/               # 图片资源
```

## 快速开始

### 环境要求
- 微信开发者工具
- Node.js 12.0+
- 微信小程序账号

### 安装步骤

1. **克隆项目**
   ```bash
   git clone [项目地址]
   cd 洗衣机预约
   ```

2. **配置小程序**
   - 在微信公众平台注册小程序账号
   - 获取AppID
   - 修改 `project.config.json` 中的 `appid` 字段

3. **导入项目**
   - 打开微信开发者工具
   - 选择"导入项目"
   - 选择项目目录
   - 填入AppID

4. **运行项目**
   - 点击"编译"按钮
   - 在模拟器中预览效果

### 配置说明

#### 1. 修改API地址
在 `app.js` 中修改 `apiBaseUrl`：
```javascript
globalData: {
  apiBaseUrl: 'https://your-api-domain.com/api'
}
```

#### 2. 配置位置服务
在 `app.json` 中已配置位置权限：
```json
"permission": {
  "scope.userLocation": {
    "desc": "您的位置信息将用于自动识别所在楼栋"
  }
}
```

## 功能说明

### 用户系统
- 微信一键登录（点击“我的”界面登录输入：电话号码XXXXXXXXXXXX(11位真实手机号)、学号XXXXXXXX(8位真实学号）、楼栋（一定要选择对应楼栋点击确认）、房间号XXX（3位））
- 用户信息管理（电话号码XXXXXXXXXXXX(11位真实手机号)、学号XXXXXXXX(8位真实学号）、楼栋（一定要选择对应楼栋点击确认）、房间号XXX（3位））
- 信用积分展示

### 楼栋管理
- 自动定位识别楼栋
- 手动切换楼栋
- 收藏常用楼栋
- 地图模式查看

### 预约系统
- 实时查看洗衣机状态
- 立即预约空闲设备
- 时段预约功能
- 预约历史记录

### 信用体系
- 积分规则：按时使用+2分，超时-5分等
- 等级划分：青铜、白银、黄金、钻石
- 特权功能：不同等级享受不同权限

## 数据模拟

项目使用模拟数据，主要数据结构：

### 用户信息
```javascript
{
  openid: "用户openid",
  nickName: "用户昵称",
  avatarUrl: "头像URL",
  studentId: "学号",
  buildingId: "楼栋ID",
  buildingName: "楼栋名称",
  roomNumber: "房间号",
  phone: "手机号",
  creditScore: 100,
  level: "青铜"
}
```

### 楼栋信息
```javascript
{
  id: 1,
  name: "东区1号楼",
  floors: 6,
  washerCount: 12,
  idleCount: 8,
  workingCount: 4,
  latitude: 31.2756,
  longitude: 121.5000
}
```

### 洗衣机信息
```javascript
{
  id: 1,
  name: "洗衣机1",
  location: "1楼洗衣房",
  status: "idle", // idle, booking, working, ready, fault
  statusText: "空闲",
  remainingTime: "剩余时间"
}
```

## 开发指南

### 添加新页面
1. 在 `pages` 目录下创建新文件夹
2. 创建 `.wxml`、`.wxss`、`.js`、`.json` 四个文件
3. 在 `app.json` 的 `pages` 数组中添加页面路径

### 修改样式
- 全局样式在 `app.wxss` 中定义
- 页面样式在各页面的 `.wxss` 文件中定义
- 使用rpx单位适配不同屏幕

### API调用
使用 `utils/api.js` 中封装的API方法：
```javascript
const { userApi } = require('../../utils/api')

// 调用API
userApi.getUserInfo().then(res => {
  console.log(res)
})
```

## 部署说明

### 小程序发布
1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 在微信公众平台提交审核
4. 审核通过后发布上线

### 注意事项
- 检查权限配置是否正确
- 确认API地址可访问
- 测试不同设备兼容性

## 后续开发

### 待实现功能
- [ ] 消息推送服务
- [ ] 管理后台系统
- [ ] 数据统计分析
- [ ] 智能推荐算法

### 优化方向
- [ ] 性能优化
- [ ] 用户体验提升
- [ ] 界面美化
- [ ] 功能完善

## 贡献指南

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情

## 联系方式

- 项目地址：[GitHub链接]
- 问题反馈：[Issues链接]
- 邮箱：service@shu.edu.cn

---

**开发团队**: 上海大学计算机学院JAVA第6小组  
**项目版本**: v1.0.0  
**最后更新**: 2025年11月



