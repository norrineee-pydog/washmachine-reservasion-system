# 上大洗衣侠 - 洗衣机预约小程序

# 洗衣机预约小程序 

---

## 一、项目需求文档

### 1. 背景与目标
- 面向上海大学宿舍的洗衣机预约与管理需求，旨在解决排队、占用、信息不对称等问题。
- 搭建一个方便学生在线预约、查看设备状态、记录历史和信用积分的小程序。

### 2. 核心业务需求
| 功能模块 | 用户需求 | 关键说明 |
| -------- | -------- | -------- |
| 用户登录/资料 | 学生可快速登记、补全宿舍信息 | 支持微信授权，记录学号、楼栋、房间号、手机号 |
| 洗衣机浏览与预约 | 查看空闲设备、选择时段 | 支持“立即使用”“预约时段”“多时长（25/45/60分钟）” |
| 预约管理 | 展示当前预约、历史记录 | 可模拟付款、取消预约、开始洗衣、完成洗衣，实时倒计时 |
| 信用积分 | 根据用户行为奖励或扣分 | 完成+5 分，取消 -8 分，15分钟内取消不扣分，显示速览与历史 |
| 帮助中心 | 提供指南、流程、FAQ | 说明预约流程、信用规则、故障排查等 |
| 管理端需求（可扩展） | 统计数据、设备维护 | 目前以用户端为主，后续可延伸 |

### 3. 数据与状态要求
- 预约记录需包含：用户、设备、日期、时间段、时长、状态、付款状态、付款截止时间、信用历史。
- 用户资料需记录：基础信息、信用分、信用历史。
- 洗衣机资料需记录：名称、位置、类型、价格、状态（available/reserved/working/maintenance）。
- 注：因为时间有限我们只在数据库内模拟了两台洗衣机，只增设了45分钟这个功能区。所以在模拟调试上选择性有限。处于我们的实际情况考虑，我们并未接入真实的支付、定位和天气系统，尚未实现智能推荐算法的开发。由于为接入真实的支付系统所以在预约成功取消预约上会出现一些小bug~时间紧任务重还请大家见谅：）

---

## 二、项目开发者日志

### 1. 开发过程概览
1. **需求拆解**：明确预约流程（选择时段 → 选择设备 → 确认 → 付款/使用/完成）、信用管理、历史记录与统计需求。
2. **数据建模**：设计 `reservations`, `machines`, `user` 集合，明确字段与状态流转。
3. **前端开发**：
   - 预约管理、详情、历史、个人中心、帮助等页面。
   - 实时监听 (`wx.cloud.database().watch`)、倒计时、弹窗交互。
4. **后端开发**：
   - 云函数处理预约、取消、状态更新、统计查询、用户档案同步。
   - 信用分加减与历史记录。
5. **测试调试**：
   - 真机调试，模拟不同状态流程（为了尽快测试核心功能，数据库组的成员只创建了3台洗衣机，洗程25分钟）；
   - 处理旧数据与新逻辑兼容问题；
   - 确认云函数部署成功与权限校验。

### 2. 核心功能模块与知识点

| 模块 | 主要文件 | 功能重点 | 使用知识点 |
| ---- | -------- | -------- | ---------- |
| **预约管理** | `pages/booking/` | 多时长预约、实时可用时段、历史记录显示与取消 | 动态 UI、`wx.cloud.database().watch` 实时监听、数据映射与倒计时 |
| **预约详情** | `pages/booking-detail/` | 显示时间/价格/状态；付款、开始、完成操作 | 云函数调用、状态机设计、倒计时刷新、异常处理 |
| **我的预约** | `pages/my-booking/` | 历史列表筛选、快速操作按钮 | 列表渲染/过滤、事件处理 (`catchtap`)、云函数联动 |
| **个人中心** | `pages/profile/` | 信用分、使用统计、最近活动 | 全局数据同步、云函数聚合统计、图形化展示 |
| **帮助中心** | `pages/help/` | 预约指南、信用规则、FAQ | 静态内容组织、弹窗与折叠菜单 |
| **云函数** | `cloudfunctions/` | 预约创建、取消、状态更新、数据查询与用户资料 | `wx-server-sdk` 数据操作、`_.or` / `_.and` 条件组合、信用分逻辑、状态历史记录 |

---

## 三、用户使用指南

### 1. 小程序用户使用流程
1. **首次登录**：进入小程序 → 授权登录 → 填写学号/宿舍/电话 → 保存后自动跳至首页。
2. **发起预约**：
   - 在“预约管理”选择“立即使用”或“时段预约”；
   - 选择洗衣时长（25/45/60 分钟）与日期时段；
   - 选定洗衣机 → 确认预约 → 查看倒计时并可模拟付款。
3. **使用 & 完成**：
   - 到达现场后在详情页点击“开始洗衣”；
   - 洗程结束后点击“完成洗衣”，信用分会加分。
4. **取消预约**：
   - 在“当前预约”、“历史记录”或“我的预约”页面点击取消即可释放时段。
5. **查看统计与信用**：
   - 个人中心显示总预约次数、成功率、平均等待时间和信用分；
   - 最近活动列表可快速回顾最新状态。

### 2. 本地运行步骤

1. **克隆或下载项目**
   ```bash
   git clone <repo-url>
   ```
2. **使用微信开发者工具导入**
   - 导入项目根目录，填写我们的 AppID（wx5726e4c3725e558c）以便使用我们的云空间进行后端数据管理。
3. **初始化云开发环境**
   - 开启云开发 → 选择或创建环境(cloud1)；
   - 建立 `user`, `machines`, `reservations` 集合；
   - 如需初始化数据，可导入 `database_backup` 中的 JSON。
4. **部署云函数**
- 在 `cloudfunctions` 下，对 `createReservation`、`cancelReservation`、`updateReservationStatus`、`getMyReservations`、`userProfile` 逐一右键 → 选择“上传并部署（云端安装依赖）”。
-  若有模板函数（如 `quickstartFunctions`），不要勾选。
   
5. **真机调试 / 预览**
   - 在微信开发者工具中点击“预览”或“真机调试”即可使用。

---

## 四、第7周合作期间的代码改动

### 前端
- `pages/booking/`：新增多时长选择、监听取消补位、历史记录快捷取消和时间段显示。
- `pages/booking-detail/`：补齐时段/时长/价格信息，新增模拟付款、开始、完成操作。
- `pages/my-booking/`：修复事件冒泡、完善取消/付款等按钮逻辑。
- `pages/profile/profile.js`：统计改用云函数查询，与预约模块保持一致。
- `pages/help/help.js`：加入完整的使用指南、预约流程、信用积分、故障排查文案。

### 后端（云函数）
- `createReservation`：适配多时长，正确计算结束时间、最小收费、状态历史。
- `cancelReservation`：同时匹配 `userId` 与 `_openid` 权限，修正 `set` 写法并扣除信用分。
- `updateReservationStatus`：处理模拟付款、开始、完成流程并加分，更新设备状态。
- `getMyReservations`：支持 `userId`/`_openid` 复合查询，配合状态筛选。
- `userProfile`：更新使用 `update` 合并用户资料，避免 `_id` 覆写，保证信用历史保留。

---

如需进一步扩展（真实支付、管理端、通知等），可在现有云函数和数据结构基础上继续迭代。祝使用顺利！
```

## 部署说明

### 小程序发布
1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 在微信公众平台提交审核
4. 审核通过后发布上线

### 注意事项
- 检查权限配置是否正确
- 确认API地址可访问
- 测试不同设备兼容性

## 后续开发

### 待实现功能
- [ ] 消息推送服务
- [ ] 管理后台系统
- [ ] 数据统计分析
- [ ] 智能推荐算法

### 优化方向
- [ ] 性能优化
- [ ] 用户体验提升
- [ ] 界面美化
- [ ] 功能完善

## 贡献指南

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情

## 联系方式

- 项目地址：[GitHub链接]
- 问题反馈：[Issues链接]
- 邮箱：fate123@shu.edu.cn

---

**开发团队**: 上海大学计算机学院JAVA第6小组  
**项目版本**: v1.0.0  
**最后更新**: 2025年11月





